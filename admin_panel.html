<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم Rx Store - الإعدادات وعرض البيانات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // تكوين Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-yellow': '#FFD700', // Gold/Yellow Accent
                        'primary-dark': '#1C1C1C',   // Dark Text/Header Color
                        'primary-bg': '#FFFFFF',     // Main Light Background
                        'card-bg': '#FAFAFA',        // Card Background
                        'text-dark': '#1C1C1C',      // Main Text Color
                        'text-secondary': '#4B5563', // Secondary Text
                        'danger-red': '#EF4444', 
                        'success-green': '#10B981',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tw-colors-primary-bg); 
            color: var(--tw-colors-text-dark);
            min-height: 100vh;
        }
        .input-style {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            color: var(--tw-colors-text-dark);
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
            text-align: right; /* محاذاة النص لليمين */
        }
        .input-style:focus {
            border-color: var(--tw-colors-primary-yellow);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5);
            outline: none;
        }
        /* لتنسيق محتوى JSON */
        #data-display pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 1rem;
            background-color: #1C1C1C;
            color: #FFFFFF;
            border-radius: 0.5rem;
            direction: ltr; /* لضمان عرض الكود بشكل صحيح */
            text-align: left;
        }
    </style>
</head>

<body class="p-4 md:p-10">
    <header class="mb-10 border-b border-gray-200 pb-4">
        <h1 class="text-3xl font-bold text-primary-dark flex items-center justify-end">
            لوحة تحكم Rx Store
            <i data-lucide="settings" class="w-7 h-7 mr-3 text-primary-yellow fill-primary-yellow/50 ml-3"></i>
        </h1>
        <p class="text-text-secondary mt-1 text-right">إدارة التوكن وعرض البيانات المنشورة.</p>
    </header>

    <section class="mb-10 p-6 bg-card-bg rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-semibold mb-6 border-b border-gray-200 pb-2 flex items-center justify-end">
            <span class="ml-2">إعدادات GitHub</span>
            <i data-lucide="github" class="w-6 h-6 text-primary-dark"></i>
        </h2>
        <form id="settings-form" class="space-y-4">
            <div>
                <label for="githubToken" class="block text-sm font-medium mb-2 text-right">GitHub Personal Access Token</label>
                <input type="password" id="githubToken" name="githubToken" required class="w-full input-style" placeholder="أدخل التوكن الخاص بك">
                <p class="text-xs text-text-secondary mt-1 text-right">يجب أن يكون لديه صلاحية (repo:contents) للوصول للملفات.</p>
            </div>
             <div>
                <label for="githubUsername" class="block text-sm font-medium mb-2 text-right">اسم مستخدم GitHub</label>
                <input type="text" id="githubUsername" name="githubUsername" required class="w-full input-style" placeholder="مثال: YOUR_USERNAME">
            </div>
             <div>
                <label for="repoName" class="block text-sm font-medium mb-2 text-right">اسم المستودع (Repository Name)</label>
                <input type="text" id="repoName" name="repoName" required class="w-full input-style" placeholder="مثال: rx-store-gh-pages">
            </div>
            <div>
                <label for="filePath" class="block text-sm font-medium mb-2 text-right">مسار ملف البيانات</label>
                <input type="text" id="filePath" name="filePath" value="store_data.js" required class="w-full input-style" disabled>
            </div>
            
            <div class="flex justify-start pt-4">
                <button type="submit" class="flex items-center px-6 py-2 bg-success-green text-white rounded-lg hover:bg-green-600 transition shadow-md font-semibold">
                    <span class="ml-2">حفظ الإعدادات</span>
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
                <button type="button" onclick="clearSettings()" class="flex items-center px-6 py-2 bg-danger-red text-white rounded-lg hover:bg-red-600 transition shadow-md font-semibold mr-2">
                    <span class="ml-2">مسح الإعدادات</span>
                    <i data-lucide="trash" class="w-5 h-5"></i>
                </button>
            </div>
        </form>
    </section>

    <section class="p-6 bg-card-bg rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-semibold mb-6 border-b border-gray-200 pb-2 flex items-center justify-end">
            <span class="ml-2">عرض البيانات المنشورة حالياً</span>
            <i data-lucide="eye" class="w-6 h-6 text-primary-dark"></i>
        </h2>
        
        <div class="text-right mb-4">
             <p id="status-message" class="text-text-secondary">يرجى حفظ التوكن أولاً ثم النقر على زر التحميل.</p>
        </div>
        
        <button id="load-data-btn" onclick="fetchAndDisplayPublishedData()" disabled class="flex items-center px-6 py-2 bg-primary-yellow text-primary-dark rounded-lg hover:bg-yellow-500 transition shadow-md font-semibold justify-end">
             <span class="ml-2">تحميل البيانات من GitHub</span>
             <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
        </button>

        <div id="data-display" class="mt-6">
            </div>
    </section>

    <div id="message-box" class="fixed bottom-4 left-4 z-50"></div>

    <script>
        lucide.createIcons();

        // ----------------------------------------------------------------
        // 1. Utility Functions (Notifications)
        // ----------------------------------------------------------------

        function showNotification(message, type = 'info') {
            const container = document.getElementById('message-box');
            const notif = document.createElement('div');
            let colorClass = '';
            let icon = '';

            if (type === 'success') {
                colorClass = 'bg-success-green';
                icon = '<i data-lucide="check-circle" class="w-5 h-5 ml-2"></i>';
            } else if (type === 'error') {
                colorClass = 'bg-danger-red';
                icon = '<i data-lucide="x-circle" class="w-5 h-5 ml-2"></i>';
            } else {
                colorClass = 'bg-primary-yellow text-primary-dark';
                icon = '<i data-lucide="info" class="w-5 h-5 ml-2"></i>';
            }

            notif.className = `p-4 rounded-lg shadow-lg flex items-center mb-3 transition duration-300 opacity-100 ${colorClass} ${type === 'info' ? 'text-primary-dark' : 'text-white'} text-right`;
            notif.innerHTML = `<span>${message}</span>${icon}`;
            
            container.prepend(notif);
            lucide.createIcons(notif); 

            setTimeout(() => {
                notif.style.opacity = '0';
                notif.addEventListener('transitionend', () => notif.remove());
            }, 3000);
        }

        // ----------------------------------------------------------------
        // 2. Settings Logic (Token, Username, Repo)
        // ----------------------------------------------------------------

        const form = document.getElementById('settings-form');
        const loadDataBtn = document.getElementById('load-data-btn');
        const githubTokenInput = document.getElementById('githubToken');
        const githubUsernameInput = document.getElementById('githubUsername');
        const repoNameInput = document.getElementById('repoName');
        const statusMessage = document.getElementById('status-message');

        function loadSettings() {
            githubTokenInput.value = localStorage.getItem('githubToken') || '';
            githubUsernameInput.value = localStorage.getItem('githubUsername') || '';
            repoNameInput.value = localStorage.getItem('repoName') || '';
            
            checkSettingsStatus();
        }
        
        function checkSettingsStatus() {
            const isReady = githubTokenInput.value && githubUsernameInput.value && repoNameInput.value;
            loadDataBtn.disabled = !isReady;
            statusMessage.innerHTML = isReady 
                ? '✅ الإعدادات كاملة. انقر على زر "تحميل البيانات" لعرض المنشور حالياً.'
                : '❌ يرجى ملء جميع الحقول وحفظ الإعدادات لتمكين تحميل البيانات.';
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            localStorage.setItem('githubToken', githubTokenInput.value);
            localStorage.setItem('githubUsername', githubUsernameInput.value);
            localStorage.setItem('repoName', repoNameInput.value);
            showNotification('تم حفظ إعدادات GitHub بنجاح!', 'success');
            checkSettingsStatus();
        });

        function clearSettings() {
             localStorage.removeItem('githubToken');
             localStorage.removeItem('githubUsername');
             localStorage.removeItem('repoName');
             githubTokenInput.value = '';
             githubUsernameInput.value = '';
             repoNameInput.value = '';
             document.getElementById('data-display').innerHTML = ''; // مسح العرض
             showNotification('تم مسح جميع الإعدادات المحفوظة.', 'info');
             checkSettingsStatus();
        }


        // ----------------------------------------------------------------
        // 3. Display Published Data Logic
        // ----------------------------------------------------------------

        async function fetchAndDisplayPublishedData() {
            const githubToken = localStorage.getItem('githubToken');
            const username = localStorage.getItem('githubUsername');
            const repo = localStorage.getItem('repoName');
            const filePath = 'store_data.js'; // المسار ثابت لملف البيانات
            const dataDisplay = document.getElementById('data-display');
            dataDisplay.innerHTML = '<p class="text-center text-primary-yellow">جاري تحميل البيانات...</p>';

            if (!githubToken || !username || !repo) {
                showNotification('يرجى حفظ إعدادات GitHub أولاً.', 'error');
                dataDisplay.innerHTML = '';
                return;
            }

            // يتم جلب محتوى الملف باستخدام GitHub API لضمان جلب آخر نسخة من الفرع الافتراضي
            const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;

            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3.raw' // لطلب المحتوى الخام مباشرة
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);
                }

                // المحتوى الخام (Text) لملف store_data.js
                const rawContent = await response.text();
                
                // البحث عن الجزء الذي يحتوي على JSON (بداية ونهاية storeData = ...)
                const match = rawContent.match(/const storeData = (\{[\s\S]*?\});/);
                
                let dataObject = {};
                if (match && match[1]) {
                    // محاولة تحليل JSON
                    try {
                        // استخدام eval هو حل سريع هنا ولكنه غير آمن في بيئات الإنتاج غير الموثوقة.
                        // بما أن المصدر هو ملف المستخدم نفسه، سنستخدمه لتبسيط العملية.
                        dataObject = (0, eval)(`(${match[1]})`);
                    } catch (e) {
                        dataDisplay.innerHTML = '<p class="text-danger-red">❌ خطأ في تحليل محتوى ملف store_data.js. ربما لم يتم نشره بشكل صحيح أو صيغة JSON خاطئة.</p>';
                        return;
                    }
                } else {
                    dataDisplay.innerHTML = '<p class="text-danger-red">❌ لم يتم العثور على متغير `storeData` في الملف المنشور.</p>';
                    return;
                }
                
                // عرض البيانات في شكل JSON منسق
                const formattedJson = JSON.stringify(dataObject, null, 2);
                dataDisplay.innerHTML = `
                    <h3 class="text-xl font-semibold mb-3 text-right">محتوى ملف store_data.js الحالي:</h3>
                    <pre dir="ltr">${formattedJson}</pre>
                `;
                showNotification('✅ تم تحميل البيانات المنشورة بنجاح.', 'success');

            } catch (error) {
                console.error('Fetch error:', error);
                dataDisplay.innerHTML = `<p class="text-danger-red">❌ فشل التحميل. ${error.message}. تأكد من صلاحية التوكن وتفاصيل المستودع.</p>`;
                showNotification('فشل في تحميل البيانات. راجع وحدة التحكم.', 'error');
            }
        }

        // **********************************
        // ******* INITIALIZATION ***********
        // **********************************
        window.onload = loadSettings;

    </script>
</body>
</html>
